<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Helsingin seudun taidenäyttelyt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Helsingin seudun taidenäyttelyt - selaa ja suodata museoiden näyttelyitä" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://museokalenteri.fi/" />
  <meta property="og:title" content="Helsingin seudun Museokalenteri" />
  <meta property="og:description" content="Helsingin seudun taidenäyttelyt - selaa ja suodata museoiden näyttelyitä" />
  <meta property="og:image" content="./museokalenteri_logo.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Helsingin seudun Museokalenteri" />
  <meta property="og:locale" content="fi_FI" />
  <meta property="og:site_name" content="Helsingin seudun Museokalenteri" />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Helsingin seudun Museokalenteri" />
  <meta name="twitter:description" content="Helsingin seudun taidenäyttelyt - selaa ja suodata museoiden näyttelyitä" />
  <meta name="twitter:image" content="./museokalenteri_logo.png" />
  <meta name="twitter:image:alt" content="Helsingin seudun Museokalenteri" />
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: auto; background: #f9f9f9; }
    h1 { text-align: center; font-size: 2rem; margin-bottom: 2rem; }
    .logo-wrapper { background-color: #ffffff; padding: 1rem; border-radius: 8px; display: inline-block; margin: 0 auto; }
    .logo { display: block; max-width: 100%; height: auto; margin: 0 auto; max-height: 300px; object-fit: contain; }
    .filter-bar, .museum-filter-bar { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .filter-btn, .museum-btn { padding: 0.5rem 1rem; font-size: 0.85rem; border: none; border-radius: 4px; cursor: pointer; background-color: #eee; }
    .filter-btn.active, .museum-btn.active { background-color: #333; color: white; }
    .museum-filter-bar { flex-direction: column; align-items: stretch; }
    .museum-btn.special { background-color: #333; color: white; width: 100%; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.08); transition: background-color 0.2s ease, box-shadow 0.2s ease; }
    .museum-btn.special:hover { background-color: #4a4a4a; box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
    .museum-btn.special:active { background-color: #2a2a2a; }
    .exhibition { background: white; margin: 1rem 0; padding: 1rem; border-left: 6px solid; border-radius: 5px; display: flex; gap: 1rem; text-decoration: none; color: inherit; transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease; align-items: stretch; position: relative; }
    .exhibition:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .exhibition:focus-visible { outline: 2px solid #333; outline-offset: 4px; }
    .CURRENT { border-color: green; }
    .UPCOMING { border-color: blue; }
    .PAST { border-color: gray; opacity: 0.7; }
    .tag { display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 4px; margin-top: 0.5rem; }
    .CURRENT .tag { background: #e6ffed; color: green; }
    .UPCOMING .tag { background: #e6f0ff; color: blue; }
    .PAST .tag { background: #eeeeee; color: gray; }
    .exhibition-image { flex: 0 0 140px; width: 140px; height: 140px; border-radius: 6px; overflow: hidden; background: linear-gradient(135deg, #f0f0f0, #d0d0d0); display: flex; align-items: center; justify-content: center; }
    .exhibition-image img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
    .exhibition-image.no-image { color: #666; font-weight: 600; font-size: 1.5rem; text-transform: uppercase; }
    .image-placeholder-text { display: block; width: 100%; text-align: center; font-size: 2rem; color: rgba(0,0,0,0.35); }
    .exhibition-content { flex: 1; display: flex; flex-direction: column; }
    .exhibition-content h2 { margin: 0 0 0.5rem 0; font-size: 1.2rem; }
    .exhibition-museum { margin: 0 0 0.25rem 0; }
    .exhibition-dates { margin: 0 0 0.5rem 0; color: #555; font-size: 0.95rem; }
    .exhibition-description { margin: 0; color: #444; font-size: 0.95rem; }
    .exhibition-content .tag { align-self: flex-start; margin-top: auto; }
    .exhibition-link-indicator { position: absolute; top: 0; right: 0; width: 36px; height: 36px; background: rgba(51, 51, 51, 0.9); color: white; display: flex; align-items: center; justify-content: center; border-top-right-radius: 5px; border-bottom-left-radius: 12px; font-size: 1.1rem; }
    .exhibition-link-indicator svg { width: 16px; height: 16px; }
    /* Sections for clearer separation */
    .section { background: #ffffff; border: 1px solid #e6e6e6; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom: 1rem; }
    .section.header { text-align: center; }
    .section.header .logo-wrapper { margin-bottom: 1rem; }
    .section .section-title { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: #444; font-weight: 600; }
    .controls-row { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
    
    /* Mobile view: stack image on top */
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .exhibition { flex-direction: column; }
      .exhibition-image { width: 100%; max-width: 100%; height: 200px; flex: 1 1 auto; }
      .exhibition-content { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="section header">
    <div class="logo-wrapper">
      <img src="./museokalenteri_logo.png" alt="Helsingin seudun Museokalenteri" class="logo" />
    </div>
    <p id="today" style="text-align:center; margin-top:0; margin-bottom:0.25rem; color:#555"></p>
    <p id="last-updated" style="text-align:center; margin-top:0; margin-bottom:0; color:#777; font-size:0.9rem"></p>
  </div>
  <div class="section">
    <p class="section-title">Aikasuodattimet</p>
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="ALL">Kaikki</button>
      <button class="filter-btn" data-filter="CURRENT">Käynnissä</button>
      <button class="filter-btn" data-filter="UPCOMING">Tulossa</button>
      <button class="filter-btn" data-filter="PAST">Päättyneet</button>
      <button class="filter-btn" data-filter="OPENING_SOON">Avautuvat 2 vk</button>
      <button class="filter-btn" data-filter="CLOSING_SOON">Päättyvät 2 vk</button>
    </div>
  </div>
  <div class="section">
    <p class="section-title">Museosuodattimet ja järjestys</p>
    <div class="controls-row" style="align-items:flex-start;">
      <div class="museum-filter-bar" style="margin:0; max-width:200px;">
        <button id="select-all-museums" class="museum-btn special">Valitse kaikki</button>
        <button id="deselect-all-museums" class="museum-btn special">Poista valinnat</button>
      </div>
      <select id="museum-select" multiple size="8" style="min-width: 260px; padding: 0.4rem; flex: 1 1 260px; max-width: 360px;"></select>
      <div class="sort-bar" style="display:flex; flex-direction:column; gap:0.35rem; margin:0;">
        <label for="sort-select" style="font-size:0.9rem; color:#333">Järjestä:</label>
        <select id="sort-select" style="padding:0.4rem 0.6rem; min-width: 180px;">
          <option value="MUSEUM">Museon mukaan</option>
          <option value="TITLE">Näyttelyn nimen mukaan</option>
          <option value="CLOSING_DATE">Päättymispäivän mukaan</option>
          <option value="OPENING_DATE" selected>Avautumispäivän mukaan</option>
        </select>
      </div>
    </div>
  </div>
  <div id="exhibitionList"></div>

  <script>
let exhibitions = [];

// Set today's date under the main headline
(function setTodayDate(){
  const todayElement = document.getElementById('today');
  if (todayElement) {
    const now = new Date();
    const formatted = now.toLocaleDateString('fi-FI', { year: 'numeric', month: 'long', day: 'numeric' });
    todayElement.textContent = `Tänään on ${formatted}`;
  }
})();

// Try to read stable creation date from a sidecar meta file first
fetch('./museonayttelyt_meta.json')
  .then(res => res.ok ? res.json() : null)
  .then(meta => {
    if (meta && meta.createdAt) {
      updateLastUpdated(meta.createdAt);
    }
  })
  .catch(() => { /* ignore missing meta file */ });

fetch('./museonayttelyt.json')
  .then(async res => {
    if (!res.ok) throw new Error("JSON not found");
    const lastModified = res.headers ? res.headers.get('Last-Modified') : null;
    const data = await res.json();
    return { data, lastModified };
  })
  .then(({ data, lastModified }) => {
    exhibitions = data;
    // Only set from Last-Modified if meta-based value not already shown
    const el = document.getElementById('last-updated');
    if (el && !el.textContent && lastModified) {
      updateLastUpdated(lastModified);
    }
    initExhibitions();
  })
  .catch(err => {
    document.getElementById("exhibitionList").innerHTML =
      "<p style='color:red'>Virhe ladattaessa museonayttelyt.json: " + err.message + "</p>";
  });

function initExhibitions() {
  // tästä alkaen sama koodi, joka oli heti const exhibitions = [...] jälkeen
  const museumSet = Array.from(new Set(exhibitions.map(ex => ex.museum))).sort();
  const museumSelect = document.getElementById('museum-select');
  if (museumSelect) {
    museumSelect.innerHTML = '';
    museumSet.forEach(museum => {
      const opt = document.createElement('option');
      opt.value = museum;
      opt.textContent = museum;
      opt.selected = true;
      museumSelect.appendChild(opt);
    });
  }

  const container = document.getElementById("exhibitionList");
  const statusButtons = document.querySelectorAll(".filter-btn");
  const selectAllBtn = document.getElementById("select-all-museums");
  const deselectAllBtn = document.getElementById("deselect-all-museums");
  const museumSelectEl = document.getElementById('museum-select');
  const sortSelect = document.getElementById("sort-select");
  let activeMuseums = new Set(museumSet);
  let activeStatus = "ALL";
  let activeSort = sortSelect ? sortSelect.value : "OPENING_DATE";

  // ✅ Korjattu: tukee sekä "DD.MM.YYYY" että "YYYY-MM-DD"
  function parseDate(dateStr) {
    if (!dateStr) return new Date(NaN);
    if (dateStr.includes('.')) {
      const [day, month, year] = dateStr.split('.').map(Number);
      return new Date(Date.UTC(year, month - 1, day));
    }
    if (dateStr.includes('-')) {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(Date.UTC(year, month - 1, day));
    }
    return new Date(dateStr); // viimeinen oljenkorsi
  }

  function computeStatus(ex) {
    const now = new Date();
    const start = parseDate(ex.start);
    const end = parseDate(ex.end);
    if (start <= now && end >= now) return "CURRENT";
    if (start > now) return "UPCOMING";
    if (end < now) return "PAST";
    return "UNKNOWN";
  }

  function getFilteredExhibitions(statusType) {
    const now = new Date();
    const in2w = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

    return exhibitions.filter(ex => {
      if (!activeMuseums.has(ex.museum)) return false;

      if (statusType === "CURRENT" || statusType === "UPCOMING" || statusType === "PAST") {
        return computeStatus(ex) === statusType;
      }

      if (statusType === "ALL") return true;

      if (statusType === "OPENING_SOON") {
        const start = parseDate(ex.start);
        return start >= now && start <= in2w;
      }

      if (statusType === "CLOSING_SOON") {
        const end = parseDate(ex.end);
        return end >= now && end <= in2w;
      }

      return true;
    });
  }

  function sortExhibitions(list) {
    const listCopy = [...list];
    const compareByString = (a, b, selector) => {
      const sa = (selector(a) || "").toString().toLowerCase();
      const sb = (selector(b) || "").toString().toLowerCase();
      return sa.localeCompare(sb);
    };
    const compareByDate = (a, b, selector) => {
      const da = parseDate(selector(a));
      const db = parseDate(selector(b));
      const va = isNaN(da) ? Infinity : da.getTime();
      const vb = isNaN(db) ? Infinity : db.getTime();
      return va - vb;
    };

    switch (activeSort) {
      case "MUSEUM":
        listCopy.sort((a, b) => compareByString(a, b, ex => ex.museum));
        break;
      case "TITLE":
        listCopy.sort((a, b) => compareByString(a, b, ex => ex.title));
        break;
      case "CLOSING_DATE":
        listCopy.sort((a, b) => compareByDate(a, b, ex => ex.end));
        break;
      case "OPENING_DATE":
      default:
        listCopy.sort((a, b) => compareByDate(a, b, ex => ex.start));
        break;
    }
    return listCopy;
  }

  function getStatusLabel(status) {
    const statusMap = {
      'CURRENT': 'Käynnissä',
      'UPCOMING': 'Tulossa',
      'PAST': 'Päättynyt',
      'UNKNOWN': 'Tuntematon'
    };
    return statusMap[status] || status;
  }

  function renderExhibitions(list) {
    container.innerHTML = "";
    if (list.length === 0) {
      container.innerHTML = "<p style='color:#555'>Suodattimillasi ei löydy näyttelyitä.</p>";
      return;
    }
    list.forEach(ex => {
      const st = computeStatus(ex);
      const statusLabel = getStatusLabel(st);
      const linkUrl = ex.Link || ex.link || "";
      const imageUrl = ex.Image || ex.image || "";
      const card = document.createElement(linkUrl ? "a" : "div");
      card.className = `exhibition ${st}`;
      if (linkUrl) {
        card.href = linkUrl;
        card.target = "_blank";
        card.rel = "noopener noreferrer";
      }
      const placeholderLetter = (ex.title || "?").trim().charAt(0).toUpperCase() || "?";
      const descriptionHtml = ex.description && ex.description.trim() ? `<p class="exhibition-description">${ex.description}</p>` : ``;
      const linkIndicator = linkUrl ? `
        <span class="exhibition-link-indicator" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M14 3h7v7h-2V6.41l-8.29 8.3-1.42-1.42 8.3-8.29H14V3z" />
            <path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z" />
          </svg>
        </span>` : "";
      card.innerHTML = `
        ${linkIndicator}
        <div class="exhibition-image${imageUrl ? "" : " no-image"}">
          ${imageUrl ? `<img src="${imageUrl}" alt="${ex.title}" loading="lazy" />` : `<span class="image-placeholder-text">${placeholderLetter}</span>`}
        </div>
        <div class="exhibition-content">
          <h2>${ex.title}</h2>
          <p class="exhibition-museum"><strong>${ex.museum}</strong></p>
          <p class="exhibition-dates">${ex.start} – ${ex.end}</p>
          ${descriptionHtml}
          <span class="tag">${statusLabel}</span>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function updateStatusCounts() {
    const now = new Date();
    const in2w = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
    let counts = { ALL:0, CURRENT:0, UPCOMING:0, PAST:0, OPENING_SOON:0, CLOSING_SOON:0 };

    exhibitions.forEach(ex => {
      if (!activeMuseums.has(ex.museum)) return;
      counts.ALL++;

      const st = computeStatus(ex);
      if (st in counts) counts[st]++;

      const start = parseDate(ex.start);
      const end = parseDate(ex.end);
      if (start >= now && start <= in2w) counts.OPENING_SOON++;
      if (end >= now && end <= in2w) counts.CLOSING_SOON++;
    });

    statusButtons.forEach(btn => {
      const type = btn.dataset.filter;
      btn.textContent = btn.textContent.replace(/ \(\d+\)$/, '') + ` (${counts[type]})`;
    });
  }

  function applyFilter(statusType) {
    activeStatus = statusType;
    const filtered = getFilteredExhibitions(statusType);
    const sorted = sortExhibitions(filtered);
    renderExhibitions(sorted);
    statusButtons.forEach(btn => btn.classList.remove("active"));
    document.querySelector(`[data-filter="${statusType}"]`).classList.add("active");
    updateStatusCounts();
  }

  if (museumSelectEl) {
    museumSelectEl.addEventListener('change', () => {
      const selected = Array.from(museumSelectEl.options)
        .filter(o => o.selected)
        .map(o => o.value);
      activeMuseums = new Set(selected);
      applyFilter(activeStatus);
    });
  }

  selectAllBtn.addEventListener("click", () => {
    if (museumSelectEl) {
      Array.from(museumSelectEl.options).forEach(o => (o.selected = true));
    }
    activeMuseums = new Set(museumSet);
    applyFilter(activeStatus);
  });
  deselectAllBtn.addEventListener("click", () => {
    if (museumSelectEl) {
      Array.from(museumSelectEl.options).forEach(o => (o.selected = false));
    }
    activeMuseums = new Set();
    applyFilter(activeStatus);
  });
  statusButtons.forEach(btn => {
    btn.addEventListener("click", () => applyFilter(btn.dataset.filter));
  });

  if (sortSelect) {
    sortSelect.addEventListener("change", () => {
      activeSort = sortSelect.value;
      applyFilter(activeStatus);
    });
  }

  updateStatusCounts();
  applyFilter("ALL");
}

function updateLastUpdated(lastModifiedHeader) {
  const el = document.getElementById('last-updated');
  if (!el) return;
  if (!lastModifiedHeader) {
    el.textContent = '';
    return;
  }
  const d = new Date(lastModifiedHeader);
  if (isNaN(d)) {
    el.textContent = '';
    return;
  }
  const formatted = d.toLocaleDateString('fi-FI', {
    year: 'numeric', month: 'long', day: 'numeric'
  });
  el.textContent = `Tiedot päivitetty: ${formatted}`;
}
  </script>
</body>
</html>